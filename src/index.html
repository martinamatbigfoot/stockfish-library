<!DOCTYPE html>
<html>
<head>
    <title>Stockfish WebAssembly Demo</title>
    <style>
        .board {
            width: 400px;
            height: 400px;
            border: 1px solid #333;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
        }
        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        .white { background-color: #f0d9b5; }
        .black { background-color: #b58863; }
        .controls {
            margin: 20px 0;
        }
        .controls button {
            margin: 0 10px;
            padding: 8px 16px;
            font-size: 16px;
        }
        #output {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            min-height: 100px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Stockfish WebAssembly Demo</h1>
    
    <div class="controls">
        <button onclick="initEngine()">Initialize Engine</button>
        <button onclick="resetPosition()">Reset Position</button>
        <button onclick="findBestMove()">Find Best Move</button>
        <input type="number" id="depth" value="10" min="1" max="30" style="width: 50px;">
        <label for="depth">Search Depth</label>
    </div>

    <div class="board" id="board"></div>
    
    <div id="output"></div>

    <script>
        // Chess state
        const startingFEN = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        let currentFEN = startingFEN;
        let engine = null;

        // Chess piece Unicode characters
        const pieces = {
            'p': '', 'n': '', 'b': '', 'r': '', 'q': '', 'k': '',
            'P': '', 'N': '', 'B': '', 'R': '', 'Q': '', 'K': ''
        };

        // Initialize the board
        function initBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = `square ${(row + col) % 2 ? 'black' : 'white'}`;
                    square.id = `square_${row}_${col}`;
                    board.appendChild(square);
                }
            }
            
            updateBoard(currentFEN);
        }

        // Update board from FEN
        function updateBoard(fen) {
            const rows = fen.split(' ')[0].split('/');
            for (let row = 0; row < 8; row++) {
                let col = 0;
                for (const char of rows[row]) {
                    if (isNaN(char)) {
                        const square = document.getElementById(`square_${row}_${col}`);
                        square.textContent = pieces[char] || '';
                        col++;
                    } else {
                        col += parseInt(char);
                    }
                }
            }
        }

        // Load the Stockfish module
        var script = document.createElement('script');
        script.src = 'stockfish.js';
        document.head.appendChild(script);

        script.onload = function() {
            log('Stockfish.js loaded. Click "Initialize Engine" to start.');
        };

        // Initialize the engine
        async function initEngine() {
            try {
                log('start');
                engine = await StockfishEngine();
                log('object');
                const result = engine.init();
                log(result);
                log('Engine initialized successfully');
                initBoard();
            } catch (error) {
                log('Error initializing engine: ' + error);
            }
        }

        // Reset to starting position
        function resetPosition() {
            if (!engine) {
                log('Please initialize the engine first');
                return;
            }

            try {
                currentFEN = startingFEN;
                const result = engine.setPosition(currentFEN);
                if (result === 'ok') {
                    updateBoard(currentFEN);
                    log('Position reset to starting position');
                } else {
                    log('Error resetting position: ' + result);
                }
            } catch (error) {
                log('Error: ' + error);
            }
        }

        // Find best move
        async function findBestMove() {
            if (!engine) {
                log('Please initialize the engine first');
                return;
            }

            try {
                const depth = document.getElementById('depth').value;
                log('Searching for best move at depth ' + depth + '...');
                
                const result = engine.getBestMove(currentFEN, parseInt(depth));
                log('Engine output: ' + result);
                
                // Parse the bestmove from the output
                const match = result.match(/bestmove\s+(\S+)/);
                if (match) {
                    const bestMove = match[1];
                    log('Best move found: ' + bestMove);
                    
                    // Make the move
                    const moveResult = engine.makeMove(bestMove);
                    if (moveResult === 'ok') {
                        // Update the display
                        currentFEN = getFEN(); // You'll need to implement getFEN()
                        updateBoard(currentFEN);
                    }
                }
            } catch (error) {
                log('Error finding best move: ' + error);
            }
        }

        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += message + '<br>';
            output.scrollTop = output.scrollHeight;
        }

        // Initialize the board on page load
        document.addEventListener('DOMContentLoaded', initBoard);
    </script>
</body>
</html>
